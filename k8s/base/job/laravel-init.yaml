apiVersion: batch/v1
kind: Job
metadata:
  name: laravel-init
  namespace: portafolio
  labels:
    app: laravel-app
spec:
  template:
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
        - name: laravel-init
          image: migbertweb/laravel-prueba
          command:
            - /bin/bash
            - -c
            - |
              set -e
              echo "üîß Ejecutando migraciones de Laravel..."

              # Esperar a que la base de datos est√© disponible
              echo "üóÑÔ∏è Verificando conexi√≥n a la base de datos..."
              until php artisan tinker --execute="DB::connection()->getPdo();" 2>/dev/null; do
                echo "‚è≥ Esperando conexi√≥n a la base de datos..."
                sleep 5
              done
              echo "‚úÖ Conexi√≥n a la base de datos establecida"

              # Ejecutar migraciones
              echo "üìä Ejecutando migraciones..."
              php artisan migrate --force
              echo "‚úÖ Migraciones completadas"

              echo "‚úÖ Inicializaci√≥n completada"
          envFrom:
            - configMapRef:
                name: laravel-config-env
            - secretRef:
                name: laravel-secret-env
          volumeMounts:
            - name: laravel-storage
              mountPath: /var/www/storage
              subPath: ""
          resources:
            requests:
              memory: "256Mi"
              cpu: "200m"
            limits:
              memory: "512Mi"
              cpu: "500m"
      volumes:
        - name: laravel-storage
          persistentVolumeClaim:
            claimName: laravel-storage-pvc
      restartPolicy: Never
  backoffLimit: 3
